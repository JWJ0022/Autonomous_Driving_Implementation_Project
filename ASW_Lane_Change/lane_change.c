/*********************************************************************************************************************/
/*-----------------------------------------------------Includes------------------------------------------------------*/
/*********************************************************************************************************************/
#include "ASW_Lane_Change/lane_change.h"

/*********************************************************************************************************************/
/*------------------------------------------------------Macros-------------------------------------------------------*/
/*********************************************************************************************************************/

#define ISR_PRIORITY_LC_T1_STM      55
#define ISR_PRIORITY_LC_T2_STM      57
#define ISR_PRIORITY_LC_T3_STM      59
#define LANE_WIDTH                  250

/*********************************************************************************************************************/
/*-------------------------------------------------Global variables--------------------------------------------------*/
/*********************************************************************************************************************/
IfxStm_CompareConfig LC_T1_STMConf;
IfxStm_CompareConfig LC_T2_STMConf;
IfxStm_CompareConfig LC_T3_STMConf;

static const float32 TARGET_ANGLE_DEGREE = 70.0f; //Îã®ÏúÑ : ÎèÑ
static const float32 TARGET_ANGLE_RADIAN = 70.0f * (IFX_PI/180); //Îã®ÏúÑ : ÎùºÎîîÏïà
static const float32 ANGULAR_VELOCITY_DEGREE = 30.0f; //Îã®ÏúÑ : ÎèÑ/Ï¥à
static const float32 ANGULAR_VELOCITY_RADIAN = 30.0f * (IFX_PI/180); //Îã®ÏúÑ : ÎùºÎîîÏïà/Ï¥à

uint32 rotation_time_T1_ticks;
float32 turn_radius = 0;

float32 rotation_time_T1;
float32 travel_time_T2 = 0;

float32 origin_left_wheelspeed = 0;
float32 origin_right_wheelspeed = 0;

int it_dist_FLAG = 0;
/*********************************************************************************************************************/
/*--------------------------------------------Private Variables/Constants--------------------------------------------*/
/*********************************************************************************************************************/

/*********************************************************************************************************************/
/*------------------------------------------------Function Prototypes------------------------------------------------*/
/*********************************************************************************************************************/

/*********************************************************************************************************************/
/*---------------------------------------------Function Implementations----------------------------------------------*/
/*********************************************************************************************************************/
void T1_rotation_Right(void)
{
    carState.lanefunc = LANE_CHANGE;
    carState.mode = DRIVING_TURNING_RIGHT;

    origin_left_wheelspeed = carState.leftWheelSpeed;
    origin_right_wheelspeed = carState.rightWheelSpeed;

    float32 Base_Speed = getCurrentSpeed();
    carState.baseSpeed = Base_Speed;

    set_turn(Right, ANGULAR_VELOCITY_RADIAN);
}

// Ï†ÑÏó≠ Î≥ÄÏàò (ÌîåÎûòÍ∑∏ Ï∂îÍ∞Ä)
boolean RightOffsetFlag1 = FALSE;  // RightOffsetÏù¥ -100 Ïù¥ÌïòÎ°ú Îñ®Ïñ¥ÏßÄÎ©¥ ON
void checkRightOffsetChange(void)
{
    //Ï∞®ÏÑ† Î≥ÄÍ≤Ω Ï§ëÏùº ÎïåÎßå Ïã§Ìñâ
    if (carState.lanefunc == LANE_CHANGE)
    {
        //RightOffsetÏù¥ -100 Ïù¥ÌïòÎ°ú Îñ®Ïñ¥ÏßÄÎ©¥ flag1ÏùÑ ON
        if (RightOffset < -100)
        {
            RightOffsetFlag1 = TRUE;
        }

        //flag1Ïù¥ ON ÏÉÅÌÉúÏóêÏÑú RightOffsetÏù¥ ÏñëÏàòÍ∞Ä ÎêòÎ©¥ Ï∞®ÏÑ† Î≥ÄÍ≤Ω ÏôÑÎ£å
        if (RightOffsetFlag1 == TRUE && RightOffset > 0)
        {
            carState.lanefunc = LANE_KEEPING;  // üöó Ï∞®ÏÑ† Ïú†ÏßÄ Î™®ÎìúÎ°ú Î≥ÄÍ≤Ω
            RightOffsetFlag1 = FALSE;  // ÌîåÎûòÍ∑∏ Ï¥àÍ∏∞Ìôî
        }
    }
}

